# 空气质量预测系统设计文档

## 1. 系统架构

### 1.1 技术栈
- 前端：Vue 3 + Vite + TypeScript + Element Plus
- 后端：FastAPI + Python 3.9+
- 数据存储：AWS S3
- AI服务：生成式AI图像服务

### 1.2 系统组件
- 前端Web应用：用户交互界面
- 后端API服务：数据处理、模型预测、图像生成
- 数据获取服务：从OpenAQ获取历史数据
- 预测模型：基于历史数据预测空气质量
- 图像生成服务：基于预测结果生成相关图像

## 2. 前端设计

### 2.1 页面布局
```
+------------------------------------------+
|                 Header                   |
+------------------------------------------+
|                                          |
|  +----------------------------------+    |
|  |        城市和日期选择区域        |    |
|  +----------------------------------+    |
|                                          |
|  +----------------------------------+    |
|  |                                  |    |
|  |         预测结果展示区域         |    |
|  |                                  |    |
|  +----------------------------------+    |
|                                          |
|  +----------------------------------+    |
|  |                                  |    |
|  |         生成图像展示区域         |    |
|  |                                  |    |
|  +----------------------------------+    |
|                                          |
|  +----------------------------------+    |
|  |         健康建议展示区域         |    |
|  +----------------------------------+    |
|                                          |
+------------------------------------------+
|                 Footer                   |
+------------------------------------------+
```

### 2.2 组件设计

#### 2.2.1 城市和日期选择组件
- 城市选择下拉框：展示支持的城市列表
- 日期选择器：允许选择未来日期进行预测
- 提交按钮：触发预测请求

#### 2.2.2 预测结果展示组件
- AQI数值显示：大号字体展示预测的AQI值
- 污染等级指示：颜色编码展示空气质量等级
- 加载状态：请求过程中显示加载动画

#### 2.2.3 图像展示组件
- 响应式图像容器：适应不同设备尺寸
- 加载状态：图像加载过程中显示占位符
- 图像放大功能：点击可查看大图

#### 2.2.4 健康建议组件
- 动态提示框：根据AQI等级显示不同的健康建议
- 图标指示：使用直观图标增强视觉效果

### 2.3 状态管理
- 使用Pinia进行状态管理
- 主要状态：
  - 用户选择的城市和日期
  - 预测结果数据
  - 加载状态
  - 错误信息

### 2.4 API交互
- 使用Axios进行HTTP请求
- 实现请求拦截器处理认证
- 实现响应拦截器统一处理错误

## 3. 后端设计

### 3.1 API端点

#### 3.1.1 获取支持的城市列表
```
GET /api/cities
Response: {
  "cities": [
    {"id": "beijing", "name": "北京", "location_id": "123456"},
    {"id": "shanghai", "name": "上海", "location_id": "234567"},
    ...
  ]
}
```

#### 3.1.2 预测空气质量
```
POST /api/predict
Request: {
  "city_id": "beijing",
  "date": "2025-06-25"
}
Response: {
  "aqi": 135,
  "level": "不健康（敏感人群）",
  "pollutants": {
    "pm25": 45.2,
    "pm10": 88.7,
    "o3": 48.2,
    "no2": 37.1,
    "so2": 9.8,
    "co": 0.9
  },
  "image_url": "https://bucket-name.s3.region.amazonaws.com/images/beijing-20250625-12345.jpg",
  "health_advice": "敏感人群应减少户外活动，建议佩戴口罩"
}
```

### 3.2 数据处理流程

1. 接收前端请求，获取城市ID和预测日期
2. 从数据库或S3获取该城市过去7天的历史数据
3. 生成预测所需特征
4. 调用预测模型获取AQI预测值和污染等级
5. 根据预测结果构造图像生成提示词
6. 调用生成式AI服务生成相关图像
7. 将图像上传到S3并获取URL
8. 根据AQI等级生成健康建议
9. 将所有结果打包返回给前端

### 3.3 错误处理
- 输入验证：确保城市ID和日期格式正确
- 数据缺失处理：处理历史数据不完整的情况
- API调用失败：处理第三方服务调用失败的情况
- 超时处理：设置合理的超时时间

### 3.4 缓存策略
- 缓存城市列表：减少数据库查询
- 缓存预测结果：相同城市和日期的请求可复用结果
- 缓存生成的图像：避免重复生成

## 4. 数据模型

### 4.1 城市信息
```python
class City(BaseModel):
    id: str
    name: str
    location_id: str
    latitude: float
    longitude: float
```

### 4.2 预测请求
```python
class PredictionRequest(BaseModel):
    city_id: str
    date: str  # YYYY-MM-DD格式
```

### 4.3 预测结果
```python
class PollutantLevels(BaseModel):
    pm25: float
    pm10: float
    o3: float
    no2: float
    so2: float
    co: float

class PredictionResponse(BaseModel):
    aqi: int
    level: str
    pollutants: PollutantLevels
    image_url: str
    health_advice: str
```

## 5. 用户交互流程详解

1. **初始页面加载**
   - 前端加载完成后自动请求城市列表
   - 默认选择第一个城市和当前日期

2. **用户选择城市和日期**
   - 用户从下拉框选择城市（如"北京"）
   - 用户使用日期选择器选择预测日期（如"2025-06-25"）
   - 用户点击"预测"按钮

3. **发送预测请求**
   - 前端验证输入
   - 显示加载状态
   - 发送POST请求到`/api/predict`

4. **后端处理**
   - 接收请求并验证参数
   - 获取城市过去7天数据
   - 生成特征并调用预测模型
   - 获取预测结果（如AQI=135，level="不健康（敏感人群）"）
   - 构造图像生成提示词
   - 调用生成式AI服务生成图像
   - 上传图像到S3获取URL
   - 生成健康建议
   - 返回完整结果给前端

5. **前端展示结果**
   - 隐藏加载状态
   - 显示AQI数值和污染等级
   - 加载并显示生成的图像
   - 显示健康建议
   - 根据污染等级调整UI颜色

6. **用户交互**
   - 用户可以点击图像查看大图
   - 用户可以选择不同城市或日期重新预测

## 6. 部署架构

### 6.1 开发环境
- 前端：本地开发服务器（Vite）
- 后端：本地FastAPI服务器
- 数据：本地测试数据

### 6.2 生产环境
- 前端：AWS S3 + CloudFront
- 后端：AWS ECS或Lambda
- 数据存储：AWS S3
- 图像存储：AWS S3
- API网关：AWS API Gateway
- 负载均衡：AWS ALB

## 7. 安全考虑

- API认证：使用API密钥或JWT
- 输入验证：防止注入攻击
- CORS配置：限制跨域请求
- 图像内容审核：确保生成的图像内容安全
- 限流：防止API滥用

## 8. 扩展性考虑

- 支持更多城市
- 添加历史数据查看功能
- 提供更长期的预测（如一周预测）
- 添加用户个性化设置
- 支持多语言 